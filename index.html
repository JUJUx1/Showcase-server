<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="theme-color" content="#050508" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>ARCADE · Game Showcase</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
<style>
/* ── Variables ─────────────────────────────────────────────────────────── */
:root {
  --bg:       #050508;
  --surface:  #0c0c14;
  --surface2: #12121e;
  --border:   #1e1e32;
  --cyan:     #00ffe1;
  --magenta:  #ff2d78;
  --yellow:   #ffe53d;
  --text:     #e2e2f0;
  --muted:    #5a5a7a;
  --radius:   6px;
  --t:        0.2s ease;
  --safe-top:    env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left:   env(safe-area-inset-left, 0px);
  --safe-right:  env(safe-area-inset-right, 0px);
}

/* ── Reset ─────────────────────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  line-height: 1.6;
  min-height: 100dvh;
  overflow-x: hidden;
  /* safe area padding for iPhone notch/home bar */
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
  padding-left: var(--safe-left);
  padding-right: var(--safe-right);
}

/* ── Scanlines (disabled on mobile for perf) ─────────────────────────── */
@media (min-width: 768px) {
  body::after {
    content: '';
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: repeating-linear-gradient(
      to bottom, transparent 0px, transparent 2px,
      rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px
    );
  }
}

/* ── Layout ──────────────────────────────────────────────────────────── */
.wrap {
  position: relative; z-index: 1;
  max-width: 1280px; margin: 0 auto;
  padding: 0 16px;
}
@media (min-width: 768px) { .wrap { padding: 0 24px; } }

/* ── Header ──────────────────────────────────────────────────────────── */
header {
  padding: 24px 0 20px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  margin-bottom: 20px;
  position: relative;
  overflow: hidden; /* stop glow from causing horizontal scroll */
}
@media (min-width: 768px) { header { padding: 40px 0 28px; margin-bottom: 32px; } }

.header-glow {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  width: min(600px, 100vw); height: 160px;
  background: radial-gradient(ellipse, rgba(0,255,225,0.07) 0%, transparent 70%);
  pointer-events: none;
}

.site-title {
  font-family: 'Orbitron', monospace;
  font-size: clamp(1.8rem, 8vw, 4rem);
  font-weight: 900;
  letter-spacing: clamp(0.05em, 2vw, 0.18em); /* shrinks on small screens */
  text-transform: uppercase;
  background: linear-gradient(135deg, var(--cyan) 0%, var(--magenta) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 20px rgba(0,255,225,0.3));
  animation: flicker 8s infinite;
  line-height: 1.1;
}

.site-sub {
  color: var(--muted);
  font-size: clamp(9px, 2.5vw, 12px);
  letter-spacing: clamp(0.1em, 2vw, 0.25em); /* never overflows */
  text-transform: uppercase;
  margin-top: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ── Live badge ──────────────────────────────────────────────────────── */
.live-badge {
  display: inline-flex; align-items: center; gap: 6px;
  font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase;
  color: var(--cyan); margin-top: 12px;
  opacity: 0; transition: opacity 0.5s;
}
.live-badge.on { opacity: 1; }
.live-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--cyan); box-shadow: 0 0 8px var(--cyan);
  animation: pulse 2s infinite; flex-shrink: 0;
}

/* ── Toolbar ─────────────────────────────────────────────────────────── */
.toolbar {
  display: flex; flex-direction: column; gap: 10px;
  margin-bottom: 20px;
}
@media (min-width: 480px) {
  .toolbar { flex-direction: row; align-items: center; justify-content: space-between; gap: 12px; }
}

.count {
  font-size: 11px; color: var(--muted); letter-spacing: 0.1em;
  text-align: center; flex-shrink: 0;
}
@media (min-width: 480px) { .count { text-align: left; } }
.count span { color: var(--cyan); font-weight: 700; }

.search-wrap { position: relative; width: 100%; }
@media (min-width: 480px) { .search-wrap { max-width: 320px; } }

.search-wrap::before {
  content: '⌕';
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: var(--muted); font-size: 16px; pointer-events: none; z-index: 1;
}
#search {
  width: 100%;
  padding: 12px 14px 12px 36px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); color: var(--text);
  font-family: 'Space Mono', monospace;
  font-size: 16px; /* critical: prevents iOS auto-zoom */
  outline: none;
  -webkit-appearance: none;
  transition: border-color var(--t);
}
#search:focus { border-color: var(--cyan); }
#search::placeholder { color: var(--muted); }

/* ── Grid ────────────────────────────────────────────────────────────── */
#grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  margin-bottom: 40px;
  /* 2 columns if screen is wide enough for at least 160px per card */
  grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
}
@media (min-width: 768px)  { #grid { gap: 20px; } }
@media (min-width: 1024px) { #grid { gap: 24px; } }

/* ── Card ────────────────────────────────────────────────────────────── */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  display: flex; flex-direction: column;
  position: relative;
  animation: cardIn 0.35s ease both;
  /* tap feedback */
  -webkit-tap-highlight-color: transparent;
  transition: border-color var(--t), box-shadow var(--t), transform var(--t);
}

/* hover only on non-touch devices */
@media (hover: hover) {
  .card:hover {
    border-color: var(--cyan);
    box-shadow: 0 6px 32px rgba(0,0,0,0.5), 0 0 16px rgba(0,255,225,0.25);
    transform: translateY(-3px);
  }
  .card:hover .card-thumb img { transform: scale(1.04); }
  .card:hover::after { opacity: 1; }
}

/* touch press effect */
.card:active { transform: scale(0.98); opacity: 0.9; }

/* corner accent on hover */
.card::after {
  content: '';
  position: absolute; top: 0; right: 0;
  border-style: solid;
  border-width: 0 24px 24px 0;
  border-color: transparent var(--magenta) transparent transparent;
  opacity: 0; transition: opacity var(--t);
  pointer-events: none;
}

/* ── Thumbnail ────────────────────────────────────────────────────────── */
.card-thumb {
  width: 100%;
  aspect-ratio: 16 / 9;
  background: var(--surface2);
  overflow: hidden;
  position: relative;
  flex-shrink: 0;
}
.card-thumb img {
  width: 100%; height: 100%; object-fit: cover; display: block;
  opacity: 0; transition: opacity 0.4s ease, transform 0.4s ease;
}
.card-thumb img.loaded { opacity: 1; }
.thumb-placeholder {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Orbitron', monospace; font-size: 28px;
  color: var(--border);
}

/* ── Card body ────────────────────────────────────────────────────────── */
.card-body {
  padding: 14px;
  flex: 1; display: flex; flex-direction: column; gap: 8px;
}
@media (min-width: 768px) { .card-body { padding: 18px; gap: 10px; } }

.card-title {
  font-family: 'Orbitron', monospace;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--text);
  /* truncate long titles */
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.4;
}

.card-desc {
  color: var(--muted);
  font-size: 11px;
  line-height: 1.65;
  flex: 1;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ── Card footer ─────────────────────────────────────────────────────── */
.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  margin-top: 4px;
  flex-wrap: nowrap;
}

.card-date {
  font-size: 10px;
  color: var(--border);
  letter-spacing: 0.04em;
  flex-shrink: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.play-btn {
  display: inline-flex; align-items: center; gap: 5px;
  flex-shrink: 0;
  padding: 0 14px;
  height: 36px;
  min-width: 70px;
  background: transparent;
  border: 1px solid var(--cyan);
  border-radius: var(--radius);
  color: var(--cyan);
  font-family: 'Orbitron', monospace;
  font-size: 10px; font-weight: 700;
  letter-spacing: 0.12em; text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  transition: background var(--t), color var(--t);
  justify-content: center;
}
.play-btn:active,
.play-btn:hover { background: var(--cyan); color: var(--bg); }
.play-btn::before { content: '▶'; font-size: 8px; }

/* ── Empty / loading ──────────────────────────────────────────────────── */
.empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 60px 20px;
  color: var(--muted);
}
.empty-icon { font-size: 40px; opacity: 0.25; display: block; margin-bottom: 14px; }
.empty-text {
  font-family: 'Orbitron', monospace;
  font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase;
}
.spinner {
  width: 36px; height: 36px;
  border: 2px solid var(--border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin: 0 auto 14px;
}

/* ── Footer ──────────────────────────────────────────────────────────── */
footer {
  border-top: 1px solid var(--border);
  padding: 20px 0 calc(20px + var(--safe-bottom));
  text-align: center;
  color: var(--muted); font-size: 11px;
  letter-spacing: 0.12em; text-transform: uppercase;
}
footer a { color: var(--cyan); text-decoration: none; }

/* ── Toast ───────────────────────────────────────────────────────────── */
#toast {
  position: fixed;
  /* sits above home indicator on iPhone */
  bottom: calc(20px + var(--safe-bottom));
  left: 16px; right: 16px;
  z-index: 999;
  padding: 12px 18px;
  background: var(--surface2);
  border: 1px solid var(--cyan);
  border-radius: var(--radius);
  font-size: 12px; letter-spacing: 0.08em;
  color: var(--cyan);
  text-align: center;
  transform: translateY(80px); opacity: 0;
  transition: all 0.3s ease;
  pointer-events: none;
  box-shadow: 0 0 20px rgba(0,255,225,0.2);
}
#toast.show { transform: translateY(0); opacity: 1; }
@media (min-width: 480px) {
  #toast { left: auto; right: 24px; max-width: 320px; text-align: left; }
}

/* ── Animations ──────────────────────────────────────────────────────── */
@keyframes flicker {
  0%,100% { opacity:1 } 92%,94% { opacity:0.82 } 96% { opacity:1 }
}
@keyframes pulse {
  0%,100% { transform:scale(1); opacity:1 }
  50%      { transform:scale(1.6); opacity:0.5 }
}
@keyframes spin    { to { transform: rotate(360deg) } }
@keyframes cardIn  {
  from { opacity:0; transform: translateY(12px) }
  to   { opacity:1; transform: translateY(0) }
}
@keyframes highlight {
  0%   { border-color: var(--yellow); box-shadow: 0 0 24px rgba(255,229,61,0.4); }
  100% { border-color: var(--border); box-shadow: none; }
}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <header>
    <div class="header-glow"></div>
    <div class="site-title">ARCADE</div>
    <div class="site-sub">Game Showcase Platform</div>
    <div class="live-badge" id="liveBadge">
      <div class="live-dot"></div>
      <span>Live</span>
    </div>
  </header>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="count">Showing <span id="countVal">0</span> game(s)</div>
    <div class="search-wrap">
      <input id="search" type="search" placeholder="Search games…"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
    </div>
  </div>

  <!-- Grid -->
  <div id="grid">
    <div class="empty">
      <div class="spinner"></div>
      <div class="empty-text">Loading…</div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    ARCADE &nbsp;·&nbsp; <a href="admin.html">Admin</a>
  </footer>

</div>

<!-- Toast -->
<div id="toast"></div>

<script>
const API = (window.ARCADE_API || 'https://showcase-server-3axe.onrender.com');
const WS  = API.replace(/^https?/, s => s === 'https' ? 'wss' : 'ws');

let allGames = [];
let query    = '';

const grid      = document.getElementById('grid');
const countVal  = document.getElementById('countVal');
const searchEl  = document.getElementById('search');
const liveBadge = document.getElementById('liveBadge');
const toastEl   = document.getElementById('toast');

// ── Fetch ─────────────────────────────────────────────────────────────────
async function fetchGames() {
  try {
    const r = await fetch(`${API}/games`);
    allGames = await r.json();
    render();
  } catch {
    grid.innerHTML = `<div class="empty">
      <span class="empty-icon">⚠</span>
      <div class="empty-text">Can't connect to server</div>
    </div>`;
  }
}

// ── Render ─────────────────────────────────────────────────────────────────
function render() {
  const q = query.toLowerCase().trim();
  const list = q
    ? allGames.filter(g =>
        g.title.toLowerCase().includes(q) ||
        g.description.toLowerCase().includes(q))
    : allGames;

  countVal.textContent = list.length;

  if (!list.length) {
    grid.innerHTML = `<div class="empty">
      <span class="empty-icon">◌</span>
      <div class="empty-text">${q ? 'No matches' : 'No games yet'}</div>
    </div>`;
    return;
  }

  grid.innerHTML = list.map((g, i) => card(g, i)).join('');

  // Lazy-load images via IntersectionObserver
  grid.querySelectorAll('img[data-src]').forEach(img => {
    const io = new IntersectionObserver((entries, obs) => {
      entries.forEach(e => {
        if (!e.isIntersecting) return;
        const el = e.target;
        el.src = el.dataset.src;
        el.onload  = () => el.classList.add('loaded');
        el.onerror = () => el.style.display = 'none';
        obs.disconnect();
      });
    }, { rootMargin: '300px' });
    io.observe(img);
  });
}

function card(g, i) {
  const date = g.createdAt
    ? new Date(g.createdAt).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'2-digit' })
    : '';
  const img = g.image
    ? `<img data-src="${esc(g.image)}" alt="${esc(g.title)}" />`
    : `<div class="thumb-placeholder">◈</div>`;

  return `<article class="card" id="card-${esc(g.id)}" style="animation-delay:${Math.min(i*0.05,0.4)}s">
    <div class="card-thumb">${img}</div>
    <div class="card-body">
      <div class="card-title">${esc(g.title)}</div>
      <div class="card-desc">${esc(g.description)}</div>
      <div class="card-footer">
        <span class="card-date">${date}</span>
        <a class="play-btn" href="${esc(g.link)}" target="_blank" rel="noopener noreferrer"
           onclick="event.stopPropagation()">Play</a>
      </div>
    </div>
  </article>`;
}

function esc(s) {
  return String(s ?? '').replace(/[&<>"']/g,
    c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// ── Search ─────────────────────────────────────────────────────────────────
searchEl.addEventListener('input', () => { query = searchEl.value; render(); });

// ── WebSocket ──────────────────────────────────────────────────────────────
function connectWS() {
  let ws, delay = 2000;

  function connect() {
    try { ws = new WebSocket(WS); } catch { return retry(); }

    ws.onopen    = () => { liveBadge.classList.add('on'); delay = 2000; };
    ws.onclose   = () => { liveBadge.classList.remove('on'); retry(); };
    ws.onmessage = ({ data }) => {
      try { handle(JSON.parse(data)); } catch {}
    };
  }

  function retry() {
    setTimeout(connect, delay = Math.min(delay * 1.5, 12000));
  }

  connect();
}

function handle({ type, payload }) {
  if (type === 'init')   { allGames = payload; render(); return; }
  if (type === 'add')    { allGames.unshift(payload); render(); flash(payload.id); toast(`Added: ${payload.title}`); }
  if (type === 'edit')   { const i = allGames.findIndex(g => g.id === payload.id); if (i > -1) allGames[i] = payload; render(); flash(payload.id); }
  if (type === 'delete') { allGames = allGames.filter(g => g.id !== payload.id); render(); toast('A game was removed'); }
}

function flash(id) {
  const el = document.getElementById(`card-${id}`);
  if (!el) return;
  el.style.animation = 'none';
  el.offsetHeight;
  el.style.animation = 'highlight 1.5s ease forwards';
}

let toastTimer;
function toast(msg) {
  clearTimeout(toastTimer);
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  toastTimer = setTimeout(() => toastEl.classList.remove('show'), 3500);
}

// ── Boot ───────────────────────────────────────────────────────────────────
fetchGames();
connectWS();
</script>
</body>
</html>
